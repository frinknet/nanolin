#!/bin/sh

export NLDIR="${NLDIR:-/etc/nanolin.d}"
export NLBIN="$0"
export NLVER=1.0.3
export NLACT="${1##*/}"
export NLHDR="
Nanolin System Control Framework v$NLVER
Copyright 2018 Frinknet and Friends
License: GPL v2.0
"
export NLEXIT=0

[ -z "$1" ] && echo "$NLHDR
	Usage:

	nanolin <action> [options]

	Actions:
	
$(find "$NLDIR" -type f -perm +111 | sed "s%$NLDIR/%\t%g" | grep -v '\.' | sort)
" && exit

shift

# check that the action exists before we go to any trouble
[ ! -e "$NLDIR/$NLACT" ] && echo "$NLHDR
The action $NLDIR/$NLACT does not exist.
" && exit

# check that the action is executable before we go to any trouble
[ ! -x "$NLDIR/$NLACT" ] && echo "$NLHDR
The user $USER does not have permission to execute $NLDIR/$NLACT.
" && exit

# set aliases to shorten code
alias runeach="'$NLDIR'/each $NLACT"
alias runexec="'$NLDIR'/$NLACT"
alias runlock="'$NLDIR'/lock"
alias logcall="'$NLDIR'/log call ${NLBIN##*/} $NLACT"
alias logwait="runlock wait 0 $NLACT && '$NLDIR'/log exit ${NLBIN##*/} $NLACT"

# run action different for special actions 
case $NLACT in
	#  run immediately without runlocks
	log|lock|check|silent) runexec $@ && NLEXIT=$?;;

	# run action and children  waiting for the children to exit 
	init|exit|login|logout|startup|shutdown) runeach $@ && NLEXIT=$?;;

	# run and set runlock pid then remove it when finished
	*) logcall $@ && (runexec $@ && NLEXIT=$?) & runlock new $NLACT $! && logwait $@ && runlock set $NLACT;;
esac

exit $NLEXIT
